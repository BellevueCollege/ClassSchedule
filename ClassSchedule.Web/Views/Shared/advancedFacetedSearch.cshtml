@*
This file is part of CtcClassSchedule.

CtcClassSchedule is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

CtcClassSchedule is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with CtcClassSchedule.  If not, see <http://www.gnu.org/licenses/>.
*@
@using CTCClassSchedule.Common
@using CTCClassSchedule.Models
@model AdvancedFacetedSearchModel

@{
  int _numCredits;
  if (!int.TryParse(Model.FacetData.Credits, out _numCredits))
  {
    _numCredits = Model.FacetData.CreditsAny; // default
  }
  int subjectsCount = Model.Subjects == null ? 0 : Model.Subjects.Count();
  string _availabilityFacet = Model.FacetData.Availability;

  // construct the route values we'll pass to the ActionLink helper
  IDictionary<string, object> routeParms = ViewBag.LinkParams;

  string _quarterParam = routeParms.Keys.Contains("quarter") ? routeParms["quarter"].ToString() : string.Empty;
}

<!--<div id="advancedFacetedSearch">-->
<div class="panel panel-default">
    <div class="panel-heading">
        <h3 class="panel-title">Refine</h3>
    </div>
    
    <div class="buffer-padding">
        @* If the user has browsed vs. searched for a term, display a different subject chooser UI  *@
        <h4>Subject</h4>
        <ul class="subject-sidenav buffer-bottom list-unstyled">
        @if (Model.IsSearch)
        {
            if (String.IsNullOrWhiteSpace(Model.SelectedSubject))
            {
                // Display all available subjects
                if (subjectsCount > 1)
                {
                    foreach (string slug in Model.Subjects)
                    {
                        // TODO: Pass SelectedSubject to Index/Search via a model
                        routeParms["Subject"] = slug;
                        <li>
                          <a href="@Url.Action("Index", "Search", new RouteValueDictionary(routeParms))">@slug</a>
                        </li>
                    }
                }
                else if (subjectsCount == 1)
                {
                    <li>@Model.Subjects.First()</li>
                }
            }
            else
            {
                // Display only the selected subject
                <li>
                @{
                    // TODO: Pass SelectedSubject to Index/Search via a model
                    routeParms.Remove("Subject");
                }
                    <a href="@Url.Action("Index", "Search", new RouteValueDictionary(routeParms))">All</a>
                </li>
                <li><b>@Model.SelectedSubject</b></li>
            }
        }
        else
        {
            // This is not a search
            if (!String.IsNullOrWhiteSpace(Model.SelectedSubject))
            {
                <li><b>@Model.SelectedSubject</b></li>
            }
            <li>@Html.Partial("subjectNavigation", Model.ViewingQuarter)</li>
        }
        </ul>

  @if (Model.IsSearch)
  {
    <div>
          <form id="daystimesform" action="@Url.Content("~/Search/")" method="get">

          <!-- hidden fields to include in form -->
          @if (!String.IsNullOrWhiteSpace(_quarterParam))
          {
            <input type="hidden" name="quarter" value="@_quarterParam"/>
          }

          @if (!String.IsNullOrWhiteSpace(Model.SelectedSubject))
          {
            <input type="hidden" name="Subject" value="@Model.SelectedSubject"/>
          }
          <input type="hidden" name="searchterm" value="@ViewBag.searchterm"/>
	  </div>
  }
  else
  {
    @:<form id="daystimesform" action="@Url.Content("~/")@(Model.ViewingQuarter != null ? Model.ViewingQuarter.FriendlyName.Replace(" ", string.Empty) : "All")/@Model.SelectedSubject" method="get">

    if (routeParms.ContainsKey("letter"))
    {
      <input type="hidden" name="letter" value="@routeParms["letter"]" />
    }
  }

  <h4>Class format</h4>
    @{
      IList<GeneralFacetInfo> modalities = Model.FacetData.Modality;
      IList<GeneralFacetInfo> days = Model.FacetData.Days;
      bool showDaysAndTimes = true;
    }
    @if (modalities.Where(m => m.Selected == true).Count() > 0)
    {
      <p class="label_checkbox_pair">
	      <a href="#" id="uncheckFormat">Uncheck all</a>
      </p>
    }

    @foreach (GeneralFacetInfo m in modalities)
    {
	    @* Determine whether or not we should display Days & Times options *@
      if (showDaysAndTimes && m.Title.Equals("Online", StringComparison.OrdinalIgnoreCase) && m.Selected && modalities.Where(o => o.Title.Equals("Online", StringComparison.OrdinalIgnoreCase) && o.Selected).Count() == 0)
      {
        showDaysAndTimes = false;
      }

        <div class="checkbox">
		    <label>
			    <input class="clear" type="checkbox" name="@m.ID" id="@m.ID" value="true" @if (m.Selected){ <text>checked='checked'</text> } /> @m.Title
            </label>
        </div>

    }

@* There are known issues with jQueryUI widgets not working properly when IE is in compatibility mode *@
    <div id="ie-compatibility-view-warning" class="alert alert-warning" style="display:none;">
      Please disable <em><a href="http://eis.unt.edu/content/ie8-compatibility-mode" style="color:red;">Compatibility Mode</a></em>.
    </div>

  @if (showDaysAndTimes)
  {
    <h4>Days and times</h4>
    <div id="times">
        <div class="form-group">
            <label for="timestart" class="sr-only">Start time</label>
            <input id="timestart" class="form-control"  name="timestart" type="text" value="@Model.FacetData.TimeStart" placeholder="Start time" />
        </div>
        <div>
            <span class="time-separator">&nbsp;-&nbsp;</span>
        </div>
        <div class="form-group">
            <label for="timeend" class="sr-only">End time</label>
            <input id="timeend" class="form-control" name="timeend" type="text" value="@Model.FacetData.TimeEnd" placeholder="End time" />
        </div>
    </div>

    <div id="days">
        <fieldset>
            <legend class="sr-only">Class days</legend>
            <div class="form-group form-group-sm">
                @foreach (GeneralFacetInfo d in days)
                {
                    string abbrv = d.Title;
                    switch ( d.ID )
                    {
                        case "day_su":
                            abbrv = "Sunday";
                            break;
                        case "day_m":
                            abbrv = "Monday";
                            break;
                        case "day_t":
                            abbrv = "Tuesday";
                            break;
                        case "day_w":
                            abbrv = "Wednesday";
                            break;
                        case "day_th":
                            abbrv = "Thursday";
                            break;
                        case "day_f":
                            abbrv = "Friday";
                            break;
                        case "day_s":
                            abbrv = "Saturday";
                            break;
                        default:
                            abbrv = d.Title;
                            break;
                    }
                    <label class="daylabel @if (d.ID == "day_su" || d.ID == "day_s"){ <text>weekend</text> }">
                    <abbr title="@abbrv">@d.Title</abbr><br />
                    <input type="checkbox" name="@d.ID" id="@d.ID"  value="true" @if (d.Selected){ <text>checked="checked"</text> } />
                    </label>
                }
            </div>
            <div id="submitjquery"></div>
        </fieldset>
    </div>
  }


  <h4>Credits</h4>
  <div id="numcredits-facet">
      <label for="numcredits" class="sr-only">Number of credits</label>
      <select class="clear form-control"name="numcredits" id="numcredits" value="true">
        <option @if (_numCredits == Model.FacetData.CreditsAny){ <text>selected='selected'</text> }>Any</option>
        @for (int i = 1; i <= 15; i++)
        {
          <option @if (_numCredits == i){ <text>selected='selected'</text> }>@i</option>
        }
      </select>
  </div>

	<h4>Other options</h4>
	<div id="latestart-facet" class="checkbox">
		<label>
			<input class="clear" type="checkbox" name="latestart" id="latestart" value="true" @if (@Model.FacetData.LateStart == "true")
                                                                                     { <text>checked='checked'</text> } />
			Late Start
		</label>
	</div>

	<h4>Availability</h4>
	<div id="availability-facet">
        <fieldset>
            <legend class="sr-only">Class availability</legend>
            <div class="radio">
                <label>
                <input id="radio_all" type="radio" name="avail" value="All" @if (@_availabilityFacet == "All" || @_availabilityFacet == null)
                                                                        { <text> checked="checked"</text> } /> All
                </label>
            </div>
            <div class="radio">
                <label>
                    <input id="radio_open" type="radio" name="avail" value="Open"	@if (@_availabilityFacet == "Open")
                                                                          { <text> checked="checked"</text> } /> Open
                </label>
            </div>
        </fieldset>
	</div>

	<div id="submit">
		<input type="submit" id="submit_days_times" name="submitbtn" value="Refine &raquo;" class="btn btn-default" />
	</div>

</form>
</div>
</div>


<script type="text/javascript">
  /* There are known issues with jQueryUI widgets not working properly when IE is in compatibility mode */
  $(document).ready(function() {
    // Compatibility view returns a value of 7 or lower (zero means no value found)
    // see http://msdn.microsoft.com/en-us/library/cc196988%28VS.85%29.aspx
    var m = document.documentMode;
    //console.log("documentMode = " + m);
    if (m > 0 && m < 8) {
      $('#ie-compatibility-view-warning').show();
    } else {
      $('#ie-compatibility-view-warning').hide();
    }
  });

  $(function () {
    $('#timestart').timepicker({
      numberOfMonths: 0,
      ampm: true
    });
    $('#timeend').timepicker({
      numberOfMonths: 0,
      ampm: true
    });

    $('#submitjquery').html('<input type="submit" id="submit_days_times" name="submitbtn" value="Refine &raquo;" class="btn btn-default" />');
    $('#submit').html('');

    //when user clicks refine, show throbber
    $('#submit_days_times').click(function () {
      $('#daystimesform').submit();
    });

    if (!$("#radio_all").is(':checked')) {
      $('#radio_all').click(function () {
        $('#daystimesform').submit();
      });
    }

    if (!$("#radio_open").is(':checked')) {
      $('#radio_open').click(function () {
        $('#daystimesform').submit();
      });
    }


    //when class formats are clicked, auto submit the form
    $('#f_oncampus').click(function () {
      $('#daystimesform').submit();
    });


    $('#f_online').click(function () {
      $('#daystimesform').submit();
    });


    $('#f_hybrid').click(function () {
      $('#daystimesform').submit();
    });


    $('#f_telecourse').click(function () {
      $('#daystimesform').submit();
    });

    $('#latestart').click(function () {
      $('#daystimesform').submit();
    });

    $('#numcredits').change(function () {
      $('#daystimesform').submit();
    });


    //when the user clicks uncheck all formats, uncheck them and resubmit the form.
    $('#uncheckFormat').click(function (event) {
      event.preventDefault();
      $('#f_oncampus').removeAttr('checked');
      $('#f_online').removeAttr('checked');
      $('#f_hybrid').removeAttr('checked');
      $('#f_telecourse').removeAttr('checked');
      $('#daystimesform').submit();
    });
  });
</script>